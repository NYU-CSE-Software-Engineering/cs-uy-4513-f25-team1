<div class="dashboard-layout">
  <%= render "application/sidebar" %>

  <div class="main-content">
    <% if flash[:created] %>
      <div class="notice"><%= flash[:created] %></div>
    <% end %>
    <% if flash[:notice] %>
      <div class="notice"><%= flash[:notice] %></div>
    <% end %>
    <% if flash[:alert] %>
      <div class="alert"><%= flash[:alert] %></div>
    <% end %>

    <!-- Project Summary Section -->
    <header class="project-header">
      <div class="project-info">
        <h1 class="project-title"><%= @project.name %></h1>
        <p class="project-description"><%= @project.description %></p>
        
        <% if @project.repo.present? && safe_url(@project.repo) %>
          <div class="project-summary-details">
            <div class="summary-item">
              <strong>Repository:</strong>
              <a href="<%= safe_url(@project.repo) %>" target="_blank" rel="noopener noreferrer"><%= @project.repo %></a>
            </div>
          </div>
        <% end %>

        <!-- Team Carousel Section -->
        <div class="collaborators-carousel-section">
          <h3 class="carousel-section-title">Collaborators:</h3>
          <% all_members = [@project_manager, *@collaborators.reject { |c| c == @project_manager }].compact %>
          <% if all_members.any? %>
            <div class="collaborators-carousel-wrapper">
              <div class="carousel-fade carousel-fade-left"></div>
              <div class="collaborators-carousel">
                <% all_members.each do |collaborator| %>
                  <%= link_to project_collaborator_path(@project, collaborator), class: "collaborator-carousel-card #{'is-manager' if collaborator.manager?}" do %>
                    <% if collaborator.manager? %>
                      <div class="manager-crown-icon">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 4l5 2.18V11c0 3.87-2.64 7.48-5 8.93-2.36-1.45-5-5.06-5-8.93V7.18L12 5z"/><path d="M12 6.5l-3.5 1.5v3c0 2.7 1.8 5.2 3.5 6.2 1.7-1 3.5-3.5 3.5-6.2V8l-3.5-1.5z"/></svg>
                      </div>
                    <% end %>
                    <div class="carousel-card-header">
                      <div class="carousel-avatar"><%= collaborator.user.username[0].upcase %></div>
                      <div class="carousel-user-info">
                        <span class="carousel-username"><%= collaborator.user.username %></span>
                        <span class="assignee-role-badge role-<%= collaborator.role %>"><%= collaborator.role.titleize %></span>
                      </div>
                    </div>
                    <div class="carousel-card-stats">
                      <div class="carousel-stat">
                        <span class="stat-value"><%= collaborator.task_count %></span>
                        <span class="stat-label">Tasks</span>
                      </div>
                      <div class="carousel-stat">
                        <span class="stat-value"><%= collaborator.completed_task_count %></span>
                        <span class="stat-label">Completed</span>
                      </div>
                      <div class="carousel-stat">
                        <span class="stat-value"><%= collaborator.contribution_percentage %>%</span>
                        <span class="stat-label">Contrib</span>
                      </div>
                    </div>
                  <% end %>
                <% end %>
              </div>
              <div class="carousel-fade carousel-fade-right"></div>
            </div>
          <% else %>
            <div class="empty-carousel-state">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
              <span>No team members yet</span>
            </div>
          <% end %>
        </div>
      </div>
    </header>

    <hr class="divider">

    <!-- Tasks Section -->
    <div class="tasks-section">
      <div class="tasks-controls">
        <h2 class="section-title">Tasks</h2>
        <% if is_manager? %>
          <%= link_to "New Task", new_project_task_path(@project), class: "button new-task-btn" %>
        <% end %>
      </div>

      <!-- Task Table with Filters -->
      <div class="task-list-container">
        <table id="tasks-table" class="task-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Priority</th>
              <th>Assignee</th>
              <th>Status</th>
              <th>Due Date</th>
            </tr>
            <tr class="filters-row">
              <th>
                <!-- No filter for Name column -->
              </th>
              <th>
                <select id="filter-priority" class="table-filter" aria-label="Filter by priority">
                  <option value="">All Priorities</option>
                  <option value="no_priority">No Priority</option>
                  <option value="low">Low</option>
                  <option value="medium">Medium</option>
                  <option value="high">High</option>
                  <option value="urgent">Urgent</option>
                </select>
              </th>
              <th>
                <select id="filter-assignee" class="table-filter" aria-label="Filter by assignee">
                  <option value="">All Assignees</option>
                  <% @collaborators.each do |collaborator| %>
                    <option value="<%= collaborator.user.username %>"><%= collaborator.user.username %></option>
                  <% end %>
                </select>
              </th>
              <th>
                <select id="filter-status" class="table-filter" aria-label="Filter by status">
                  <option value="">All Statuses</option>
                  <option value="todo">To Do</option>
                  <option value="in_progress">In Progress</option>
                  <option value="in_review">In Review</option>
                  <option value="completed">Completed</option>
                </select>
              </th>
              <th>
                <select id="filter-due-date" class="table-filter" aria-label="Filter by due date">
                  <option value="">All Due Dates</option>
                  <option value="overdue">Overdue</option>
                  <option value="due_today">Due Today</option>
                  <option value="due_this_week">Due This Week</option>
                  <option value="due_this_month">Due This Month</option>
                  <option value="no_due_date">No Due Date</option>
                </select>
              </th>
            </tr>
          </thead>
          <tbody>
            <% if @tasks.any? %>
              <% @tasks.each do |task| %>
                <% task_url = project_task_path(@project, task) %>
                <tr class="task-row" 
                    data-task-url="<%= task_url %>"
                    data-status="<%= task.status %>"
                    data-assignee="<%= task.assignee&.user&.username || '' %>"
                    data-priority="<%= task.priority || 'no_priority' %>"
                    data-due-date="<%= task.due_at&.iso8601 || '' %>">
                  <td class="task-title-cell">
                    <%= link_to task_url, class: "task-row-link" do %>
                      <span class="task-title"><%= task.title %></span>
                      <% if task.type.present? %>
                        <span class="task-type-badge" data-type="<%= task.type.upcase %>"><%= task.type %></span>
                      <% end %>
                    <% end %>
                  </td>
                  <td>
                    <%= link_to task_url, class: "task-row-link" do %>
                      <% priority_value = task.priority || 'no_priority' %>
                      <span class="priority-badge priority-<%= priority_value.gsub('_', '-') %>">
                        <%= priority_value == 'no_priority' ? 'No Priority' : priority_value.titleize %>
                      </span>
                    <% end %>
                  </td>
                  <td class="assignee-cell">
                    <%= link_to task_url, class: "task-row-link" do %>
                      <% if task.assignee.present? %>
                        <span class="user-name"><%= task.assignee.user.username %></span>
                      <% else %>
                        <span class="text-muted">Unassigned</span>
                      <% end %>
                    <% end %>
                  </td>
                  <td>
                    <%= link_to task_url, class: "task-row-link" do %>
                      <span class="status-badge status-<%= task.status.gsub('_', '-') %>">
                        <%= task.status.titleize %>
                      </span>
                    <% end %>
                  </td>
                  <td>
                    <%= link_to task_url, class: "task-row-link" do %>
                      <% if task.due_at.present? %>
                        <%= task.due_at.strftime("%B %d, %Y") %>
                      <% else %>
                        <span class="text-muted">No due date</span>
                      <% end %>
                    <% end %>
                  </td>
                </tr>
              <% end %>
            <% else %>
              <tr>
                <td colspan="5" class="empty-table-state">No tasks found</td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

