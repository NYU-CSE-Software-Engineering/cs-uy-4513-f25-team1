<div class="project-header d-flex justify-content-between align-items-center mb-4">
  <div>
    <h1 class="mb-2"><%= @project.name %></h1>
    <p class="text-muted" style="margin: 0;"><%= @project.description %></p>
  </div>
  <div class="flex space-x-2">
    <%= link_to "Edit Project", edit_project_path(@project), class: "btn btn-secondary" %>
    <%= link_to "Delete Project", @project, data: { turbo_method: :delete, turbo_confirm: "Are you sure?" }, class: "btn btn-danger" %>
    <%= link_to "New Task", new_project_task_path(@project), class: "btn btn-primary" %>
  </div>
</div>

<div class="card" data-controller="context-menu">
  <% if @tasks.any? %>
    <div class="task-list-header">
      <div class="col-id">ID</div>
      <div class="col-status">Status</div>
      <div class="col-title">Title</div>
      <div class="col-priority">Priority</div>
      <div class="col-assignee">Assignee</div>
    </div>
    
    <div class="task-list-body">
      <% @tasks.each do |task| %>
        <div class="task-row" 
             data-action="click->context-menu#navigate contextmenu->context-menu#open"
             data-url="<%= project_task_path(@project, task) %>"
             data-edit-url="<%= edit_project_task_path(@project, task) %>"
             data-delete-url="<%= project_task_path(@project, task) %>">
          <div class="col-id text-muted">#<%= task.id %></div>
          <div class="col-status">
            <span class="status-dot status-<%= task.status %>"></span>
            <%= task.status.humanize %>
          </div>
          <div class="col-title"><%= task.title %></div>
          <div class="col-priority">
            <span class="<%= priority_badge_class(task.priority) %>"><%= task.priority.humanize %></span>
          </div>
          <div class="col-assignee">
            <% if task.user %>
              <span class="avatar-sm"><%= task.user.username&.first&.upcase || "U" %></span>
            <% else %>
              <span class="text-muted">-</span>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>

    <!-- Context Menu -->
    <div class="context-menu" data-context-menu-target="menu" style="display: none;">
      <div class="context-menu-item" data-action="click->context-menu#edit">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-edit-2"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
        Edit Task
      </div>
      
      <div class="context-menu-item has-submenu">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-circle"><circle cx="12" cy="12" r="10"></circle></svg>
        Status
        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right ml-auto"><polyline points="9 18 15 12 9 6"></polyline></svg>
        
        <div class="context-submenu">
          <div class="context-menu-item" data-action="click->context-menu#updateStatus" data-status="todo">
            <span class="status-dot status-todo"></span> Todo
          </div>
          <div class="context-menu-item" data-action="click->context-menu#updateStatus" data-status="in_progress">
            <span class="status-dot status-in_progress"></span> In Progress
          </div>
          <div class="context-menu-item" data-action="click->context-menu#updateStatus" data-status="done">
            <span class="status-dot status-done"></span> Done
          </div>
        </div>
      </div>

      <div class="context-menu-divider"></div>
      <div class="context-menu-item text-danger" data-action="click->context-menu#delete">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-trash-2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
        Delete Task
      </div>
    </div>

  <% else %>
    <div class="empty-state">
      <p class="text-muted">No tasks found in this project.</p>
      <%= link_to "Create Task", new_project_task_path(@project), class: "btn btn-primary mt-2" %>
    </div>
  <% end %>
</div>

<style>
  .card {
    background: var(--bg-app);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    overflow: hidden;
    position: relative; /* For context menu positioning context if needed, though fixed is better usually */
  }
  
  .task-list-header {
    display: flex;
    padding: 10px 16px;
    background: var(--bg-sidebar);
    border-bottom: 1px solid var(--border-color);
    font-size: 12px;
    font-weight: 600;
    color: var(--text-secondary);
    text-transform: uppercase;
  }
  
  .task-row {
    display: flex;
    padding: 12px 16px;
    border-bottom: 1px solid var(--border-subtle);
    align-items: center;
    color: var(--text-primary);
    text-decoration: none;
    font-size: 14px;
    transition: background-color 0.1s;
    cursor: default; /* Change cursor to default to look less like a link if desired, or keep pointer */
  }
  
  .task-row:last-child {
    border-bottom: none;
  }
  
  .task-row:hover {
    background-color: var(--bg-hover);
    text-decoration: none;
  }
  
  /* Columns */
  .col-id { width: 60px; font-family: var(--font-mono); font-size: 12px; }
  .col-status { width: 140px; display: flex; align-items: center; gap: 8px; }
  .col-title { flex-grow: 1; font-weight: 500; }
  .col-priority { width: 80px; text-align: center; }
  .col-assignee { width: 80px; text-align: right; }
  
  /* Status Dots */
  .status-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: 2px solid currentColor;
  }
  .status-todo { color: var(--text-tertiary); }
  .status-in_progress { color: #d29922; background: #d29922; } /* Yellow/Orange */
  .status-done { color: var(--primary-color); background: var(--primary-color); }
  
  .avatar-sm {
    display: inline-block;
    width: 20px;
    height: 20px;
    background: var(--border-color);
    color: var(--text-secondary);
    border-radius: 50%;
    text-align: center;
    line-height: 20px;
    font-size: 10px;
    font-weight: bold;
  }
  
  .empty-state {
    padding: 40px;
    text-align: center;
  }

  /* Context Menu */
  .context-menu {
    position: fixed;
    z-index: 1000;
    background: #2e2e2e; /* Dark background like Linear */
    border: 1px solid #444;
    border-radius: 6px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    padding: 4px 0;
    min-width: 180px;
    color: #eee;
    font-size: 13px;
  }

  .context-menu-item {
    padding: 8px 12px;
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    transition: background-color 0.1s;
    position: relative; /* For submenu positioning */
  }

  .context-menu-item:hover {
    background-color: #3e3e3e;
  }

  .context-menu-item.text-danger {
    color: #ff6b6b;
  }
  
  .context-menu-item.text-danger:hover {
    background-color: rgba(255, 107, 107, 0.1);
  }

  .context-menu-divider {
    height: 1px;
    background-color: #444;
    margin: 4px 0;
  }

  .ml-auto {
    margin-left: auto;
  }

  /* Submenu */
  .context-submenu {
    display: none;
    position: absolute;
    left: 100%;
    top: -4px;
    background: #2e2e2e;
    border: 1px solid #444;
    border-radius: 6px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    padding: 4px 0;
    min-width: 160px;
  }

  .context-menu-item:hover .context-submenu {
    display: block;
  }
</style>
