<div class="d-flex gap-2 mb-4 text-muted" style="font-size: 14px;">
  <%= link_to @project.name, project_path(@project), class: "text-muted" %> 
  <span>/</span>
  <span>Task #<%= @task.id %></span>
</div>

<div class="app-layout-columns" style="display: grid; grid-template-columns: 1fr 300px; gap: 40px;">
  
  <!-- Main Content -->
  <div class="task-main">
    <div class="task-header mb-4">
      <div class="d-flex align-items-center gap-2 mb-2">
        <span class="status-badge status-<%= @task.status %>"><%= @task.status.humanize %></span>
      </div>
      <h1><%= @task.title %></h1>
    </div>

    <% if @task.github_branch.present? %>
      <div class="info-box mb-4">
        <div class="text-muted mb-1" style="font-size: 12px; text-transform: uppercase; font-weight: 600;">GitHub Branch</div>
        <%= link_to @task.github_branch, "https://github.com/#{@task.github_branch}", target: "_blank", class: "d-flex align-items-center gap-2" %>
      </div>
    <% end %>

    <div class="section mb-4">
      <h3 class="section-title">Description</h3>
      <% if @task.description.present? %>
        <div class="content-body">
          <%= simple_format(@task.description) %>
        </div>
      <% else %>
        <p class="text-muted font-italic">No description provided.</p>
      <% end %>
    </div>

    <div class="section mb-4">
      <h3 class="section-title">Attachments</h3>
      <% if @task.attachments.attached? %>
        <ul class="attachment-list">
          <% @task.attachments.each do |attachment| %>
            <li class="attachment-item">
              <%= link_to attachment.filename, rails_blob_path(attachment, disposition: "attachment") %>
              <span class="text-muted" style="font-size: 12px;">(<%= number_to_human_size(attachment.byte_size) %>)</span>
            </li>
          <% end %>
        </ul>
      <% else %>
        <p class="text-muted mb-2">No attachments.</p>
      <% end %>

      <div class="upload-form mt-2">
        <%= form_with model: [@project, @task], local: true, class: "d-flex gap-2" do |f| %>
          <%= f.file_field :attachments, multiple: true, class: "form-control form-control-sm", style: "width: auto;" %>
          <%= f.submit "Upload", class: "btn btn-secondary btn-sm" %>
        <% end %>
      </div>
    </div>
    
    <div class="section">
      <h3 class="section-title">Discussion</h3>
      <div class="comments-list mb-4">
        <% @comments.each do |comment| %>
          <div class="comment-item">
            <div class="comment-header d-flex justify-content-between">
              <strong><%= comment.user&.username || "User" %></strong>
              <span class="text-muted" style="font-size: 12px;"><%= time_ago_in_words(comment.created_at) %> ago</span>
            </div>
            <div class="comment-body mt-1">
              <%= simple_format(comment.body) %>
            </div>
          </div>
        <% end %>
      </div>

      <div class="new-comment-form">
        <%= form_with model: [@project, @task, @comment], local: true do |f| %>
          <div class="form-group">
            <%= f.text_area :body, rows: 3, class: "form-control", placeholder: "Add a comment..." %>
          </div>
          <div class="d-flex justify-content-end">
            <%= f.submit "Comment", class: "btn btn-primary" %>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Sidebar -->
  <div class="task-sidebar">
    <div class="sidebar-group mb-4">
      <div class="sidebar-label">Status</div>
      <div class="sidebar-value"><%= @task.status.humanize %></div>
    </div>
    
    <div class="sidebar-group mb-4">
      <div class="sidebar-label">Priority</div>
      <div class="sidebar-value"><%= @task.priority %></div>
    </div>
    
    <div class="sidebar-group mb-4">
      <div class="sidebar-label">Assignee</div>
      <div class="sidebar-value">
        <% if @task.user %>
          <div class="d-flex align-items-center gap-2">
            <span class="avatar-sm"><%= @task.user.username.first.upcase %></span>
            <%= @task.user.username %>
          </div>
        <% else %>
          <span class="text-muted">Unassigned</span>
        <% end %>
      </div>
    </div>
    
    <div class="sidebar-group mb-4">
      <div class="sidebar-label">Created</div>
      <div class="sidebar-value"><%= @task.created_at.strftime("%b %d, %Y") %></div>
    </div>
    
    <hr style="border: 0; border-top: 1px solid var(--border-color); margin: 20px 0;">
    
    <%= link_to "Edit Task", edit_project_task_path(@project, @task), class: "btn btn-secondary btn-block" %>
  </div>
</div>

<style>
  .section-title {
    font-size: 16px;
    border-bottom: 1px solid var(--border-subtle);
    padding-bottom: 8px;
    margin-bottom: 16px;
  }
  
  .info-box {
    background: var(--bg-sidebar);
    padding: 12px;
    border-radius: var(--radius-md);
    border: 1px solid var(--border-color);
  }
  
  .status-badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 500;
    text-transform: uppercase;
    background: var(--bg-active);
    color: var(--text-primary);
  }
  
  .attachment-list {
    list-style: none;
    padding: 0;
  }
  
  .attachment-item {
    padding: 4px 0;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .comment-item {
    padding: 12px 0;
    border-bottom: 1px solid var(--border-subtle);
  }
  
  .sidebar-label {
    font-size: 12px;
    font-weight: 600;
    color: var(--text-secondary);
    margin-bottom: 4px;
    text-transform: uppercase;
  }
  
  .sidebar-value {
    font-size: 14px;
    color: var(--text-primary);
  }
  
  .avatar-sm {
    display: inline-block;
    width: 20px;
    height: 20px;
    background: var(--primary-color);
    color: white;
    border-radius: 50%;
    text-align: center;
    line-height: 20px;
    font-size: 10px;
  }
</style>
